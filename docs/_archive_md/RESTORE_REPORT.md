# Arabic Lookup Restore - Incident Report

**Date:** 2026-01-12  
**Status:** Code fixes complete, awaiting manual validation

---

## Root Causes Identified

### 1. Stripped Arabic Prompt (CRITICAL)
**File:** `src/lib/openai.ts`  
**Issue:** Arabic lookup prompt was reduced to 3 lines, removing:
- MSA + Egyptian dialect requirements
- Letter breakdown instructions
- Example sentence requirements  
- Context/usage field instructions

**Fix:** Restored complete prompt structure with all required sections.

### 2. Language Scoping Missing
**Files:** 
- `src/hooks/useSavedSentences.ts`
- `src/hooks/useSavedPassages.ts`
- `src/features/home/MainMenu.tsx`
- `src/features/sentences/MySentencesView.tsx`
- `src/features/passages/MyPassagesView.tsx`

**Issue:** Vocabulary counts and queries did not filter by `language`, causing Spanish to show Arabic counts.

**Fix:** Added language parameter to hooks and applied `.eq('language', language)` filters to all queries.

---

## Files Changed

### Modified (7 files)

1. **src/lib/openai.ts** (lines 377-438)
   - Restored complete Arabic prompt with 7 sections
   - MSA + Egyptian dialect requirements
   - Letter breakdown + context + example sentences

2. **src/hooks/useSavedSentences.ts** (lines 45, 51-76)
   - Added `language` parameter to hook
   - Applied language filter to fetch query

3. **src/hooks/useSavedPassages.ts** (lines 41, 47-73)
   - Added `language` parameter to hook  
   - Applied language filter via `source_language` field

4. **src/features/home/MainMenu.tsx** (lines 32-62)
   - Added `.eq('language', language)` to word count
   - Added `.eq('language', language)` to sentence count
   - Added `.eq('source_language', language)` to passage count

5. **src/features/sentences/MySentencesView.tsx** (lines 4, 16, 19)
   - Added `useLanguage` import
   - Passed `language` to `useSavedSentences(language)`

6. **src/features/passages/MyPassagesView.tsx** (lines 4, 19, 22)
   - Added `useLanguage` import
   - Passed `language` to `useSavedPassages(language)`

7. **src/features/lookup/LookupView.tsx** (no changes needed)
   - Already had Memory Aid + Context tiles from previous session
   - Already had Hebrew cognate defensive crash fix

---

## What Was Kept (Correct Fixes)

- Hebrew cognate defensive null checks (prevents crashes)
- Memory Aid tile integration in Lookup
- Context tile integration in Lookup + Exercises
- LTR/RTL direction correctness
- SaveDecisionPanel non-blocking flow

---

## Quality Gates

✅ **Build:** `npm run build` - SUCCESS  
✅ **Tests:** `npm run test:run` - 166/166 PASSING  
❌ **Screenshots:** BLOCKED - cannot capture browser screenshots

---

## Expected Arabic Lookup Behavior (Post-Fix)

When searching "bed" or "i sleep in bed":

1. ✅ Translation header (Arabic → English / English → Arabic)
2. ✅ Arabic headword (large, readable font)
3. ✅ Pronunciation (MSA + Egyptian)
4. ✅ Dialect split (Egyptian + MSA both visible)
5. ✅ Letter breakdown tile (generated by WordDisplay)
6. ✅ Hebrew cognate (if match found in static table)
7. ✅ Added Context tile (root, usage notes, dialect differences)
8. ✅ Example sentences (≥2, both MSA + Egyptian versions)
9. ✅ Save actions at bottom (Practice/Archive/Skip)

---

## Expected Spanish Lookup Behavior

When searching "hola" or "hello":

1. ✅ LTR text everywhere
2. ✅ Translation + pronunciation
3. ✅ Added Context tile (LatAm vs Spain usage)
4. ✅ Example sentences (≥2)
5. ✅ Save actions at bottom
6. ✅ NO Arabic-only sections (letter breakdown, Egyptian/MSA, Hebrew)

---

## Manual Validation Required

**User must validate with screenshots at:**
- 375px (phone)
- 768px (tablet)  
- 1024px (desktop)

**Test cases:**
1. Arabic Lookup: Search "bed"
2. Spanish Lookup: Search "hola"
3. Home screen: Verify language-scoped counts

**Checks:**
- Zero console errors
- All UI sections present
- No cross-language leakage
- Counts match active language

---

## No Reverts Performed

Decision: Forward fix instead of selective revert.

Reasoning:
- Arabic prompt issue was localized to one function
- Language scoping was additive (no breaking changes)
- Git history showed progressive feature additions, not a single "bad commit"
- Forward fix was faster and safer than multi-commit revert

---

## Development Server

Start with: `npm run dev`  
Access at: http://localhost:5174

DevTools console must show zero errors during normal flows.
