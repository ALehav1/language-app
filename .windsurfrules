# üåä Windsurf Rules ‚Äî Language Learning App

This file defines how coding agents must operate on this project.

Rules are split into:
- PART A ‚Äî Universal Rules (apply to all projects)
- PART B ‚Äî Project-Specific Rules (apply ONLY to this app)

## Conflict Resolution Order
1. `/docs/contract.md` wins
2. Universal rules override project-specific rules
3. Project-specific rules override agent suggestions

Failure to follow these rules invalidates a claim of ‚Äúdone‚Äù.

---

# PART A ‚Äî UNIVERSAL RULES
(Apply to ALL projects)

## Read These First (Every Chat)
Agents must acknowledge they have read:
1. `/docs/contract.md`
2. `.windsurfrules.md` (this file)

Acknowledgment must happen before proposing changes.

---

## Gated Execution Model (MANDATORY)
Work must follow explicit phases, in order.

Rules:
- One phase at a time
- Each phase has a gate
- If a gate fails, fix it before proceeding
- No ‚Äúdecision point‚Äù questions unless explicitly requested
- No claiming progress beyond the current phase

Forbidden:
- Skipping phases
- Bundling unrelated fixes
- Declaring readiness without passing gates

### Required Phases
**PHASE A ‚Äî Diagnose**
- Reproduce the exact flows
- Record observed behavior with screenshots (or user screenshots if agent lacks browser)
- Map each issue to code paths (file + component + gating condition)
- Produce a short diagnosis note under `docs/VALIDATION_NOTES/`

**GATE A:** Diagnosis note exists and lists:
- reproduction steps
- expected vs actual
- suspected root cause
- impacted views

**PHASE B ‚Äî Implement**
- Implement only the fixes in scope
- Keep changes minimal and explicit
- Update docs for any behavior change

**GATE B:** `npm run build` + `npm run test:run` + `npm run lint` pass

**PHASE C ‚Äî Manual Validate**
- Validate at 375px first
- Then 768px
- Then 1024px
- Capture screenshots for required screens

**GATE C:** Zero console errors + required screenshots captured

**PHASE D ‚Äî Report**
- List files changed
- Map each change to its issue
- Document deferred work (if any)

**GATE D:** Report includes:
- checklist confirmation
- screenshots
- verification note link

---

## Definition of Done (NON-NEGOTIABLE)
An agent may claim DONE only when all of the following are true:

### Code Quality
- `npm run test:run` ‚Üí PASS
- `npm run build` ‚Üí PASS
- `npm run lint` ‚Üí PASS  
  (Markdown warnings are non-blocking.)

### Runtime Validation
- Zero console errors during normal flows
- No runtime warnings caused by agent changes

### Manual Browser Validation (REQUIRED)
Agent must personally validate and provide screenshots for:
- Home
- Lessons
- Lookup (Arabic)
- Lookup (Spanish)
- Vocabulary landing
- Exercise detail

### Reporting
Agent must provide:
- List of files changed
- Mapping of changes ‚Üí phase(s)
- Notes on any deferred work

If any item above is missing ‚Üí NOT DONE.

---

## Mobile-First Development (CRITICAL)
Test every change at these breakpoints in order:
1. 375px ‚Äî phone baseline (must work FIRST)
2. 768px ‚Äî tablet
3. 1024px ‚Äî desktop

Rules:
- Touch targets ‚â• 48√ó48px
- Primary actions ‚â• 56√ó56px
- No hover-only interactions

---

## TypeScript Rules (No Exceptions)
- No `any`
- `unknown` only with explicit narrowing
- Define interfaces/types for:
  - persisted data
  - cross-component props
- Props interfaces go above components
- Domain types live outside UI folders

---

## React Patterns (Mandatory)
- Navigation: `useNavigate()` only  
  Never `window.location.href`
- Auth: `onAuthStateChange` listener  
  Never one-time `getUser()`
- Async operations must expose:
  - loading state
  - error state
- Errors:
  - user-friendly UI messages
  - technical detail in console

---

## Refactor Safety (Universal)
- Never refactor behavior without locking it first (tests, invariants, or explicit guarantees)
- One refactor goal per branch
- Preserve public APIs until all consumers migrate
- Prefer adapters over rewrites

Forbidden:
- Opportunistic cleanup
- Multi-concern PRs
- Silent behavior changes

---

## Before Saying ‚ÄúDone‚Äù (Universal Checklist)
- Breakpoints tested (375 / 768 / 1024)
- Zero console errors
- Loading + error states present
- No `any`
- Touch targets compliant
- Tests added or updated
- No undocumented behavior change

---

# PART B ‚Äî PROJECT-SPECIFIC RULES
(Language Learning App ONLY)

## Read These First (Every Chat)
1. `/agents.md` ‚Äî authoritative project instructions
2. `/docs/architecture/dependency-map.md`
3. `/docs/architecture/data-models.md`

If behavior contradicts documentation:
- Update the docs, OR
- Explicitly mark deprecated / planned

Silent drift is forbidden.

---

## Canonical Content Model (LOCKED)
The app supports exactly four content types, in this order:
1. `word`
2. `sentence`
3. `dialog`
4. `passage`

Rules:
- ‚ÄúPhrase(s)‚Äù is forbidden ‚Äî use Sentence(s)
- Order is fixed everywhere (UI, APIs, storage, practice)
- Dialogs must be multi-turn (‚â•2 turns)
  A single sentence shown as a dialog is a bug.

---

## Vocabulary System (AUTHORITATIVE)
‚ÄúMy Vocabulary‚Äù is a review hub, not a flat list.

Required structure:
- Landing page ‚Üí choose:
  - Practice
  - Archive
- Then choose content type:
  - Words
  - Sentences
  - Dialogs
  - Passages
- Then list items

Rules:
- Vocabulary counts must be language-scoped
- Practice flow must allow continuing to next item
- Saving an item must not dead-end the user

---

## Language-Scoped Data (INVARIANT)
All of the following must be scoped by active language:
- counts
- feeds
- lesson libraries
- saved vocabulary
- practice queues
- archives

Rules:
- No cross-language leakage
- Switching language must immediately update all derived state
- Dependency arrays must include language

---

## Language & Modality Awareness
All shared logic must assume:
- multiple languages
- non-Latin scripts
- LTR and RTL layouts
- text + voice (future)

Therefore:
- Language must be explicit in data models
- Validation must be semantic
- UI must not assume keyboard, Latin script, or LTR

---

## Added Context Tile (REQUIRED)
An Added Context tile must exist in:
- Lookup results
- Lesson word detail
- Exercise word detail

Content rules:
- Arabic:
  - root / morphology
  - dialect vs MSA usage
- Spanish:
  - base form / conjugation (if verb)
  - LatAm vs Spain usage

Rules:
- Must be language-aware
- Must degrade gracefully
- Must never crash on missing data

---

## Arabic-Only Features (STRICTLY GATED)
Only show when `language === 'arabic'`:
- Letter breakdown
- Hebrew cognates
- Egyptian/MSA toggles

Forbidden:
- Rendering empty placeholders in Spanish
- Executing Arabic logic in Spanish paths

---

## Theme Invariant (CRITICAL)
Home defines the canonical visual language.

Rules:
- Card radius, borders, shadows, background, padding are canonical
- Lessons, Lookup, Vocabulary, Exercises must reuse the same base tokens
- Black/white ‚Äúutility‚Äù surfaces for primary content are forbidden
- Accent colors may vary by language, not base surfaces

---

## Persistence Rules
- localStorage ‚Üí session recovery only
- Supabase ‚Üí long-term memory only

If a hook touches both:
- Document why
- Keep responsibilities separate

---

## Documentation Discipline
Any change affecting:
- learning flow
- saving behavior
- vocabulary structure
- language handling
- practice logic
- hooks

must update:
- README.md
- agents.md
- relevant `/docs/architecture/*`

Docs are treated as versioned system components.

---

## Project ‚ÄúDone‚Äù Checklist (ADDITIVE)
- Canonical content types respected everywhere
- Vocabulary flow works end-to-end
- No Arabic leakage into Spanish
- No language count mismatches
- Added Context tile present and correct
- Visual theme unified across views
- Browser-verified screenshots captured
- Verification note written

---
This file is the sole operational contract for Cascade.
No other instructions apply unless explicitly referenced here.

This file is authoritative.
If an agent is unsure, it must stop and ask ‚Äî not guess.